<script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="/js/draw_board.js"></script>
<script src="/js/kinetic.js"></script>

<html>
<head><title><%= title %></title>
<link href="/css/challenge.css" rel="stylesheet" type="text/css">
</head>
<body>
</br>
</br>
<div align = 'center' class = "score">0</div>
<div align = 'center' id = 'container' > </div>
<div align='center' class = 'content'>
<div id = "controls" align = "center">
		<form id = "input">
			</br>
			<label for ="dx"> dx = </label>
			<input id = "dx" type = "text" class = "equation" value = "1">
			</br>
			<label for ="dy"> dy = </label>
			<input id = "dy" type = "text" class = "equation" value = "0">
			</br>
			</br>
			<input type="submit" value= "Reset" id ="reset">
			<input type="submit" value= "Draw" id ="draw">
		</form>
</div>
</div>
<script type="text/javascript">

	//get the data
	var json = <%- JSON.stringify(game) %>;
	balls = json.balls;
	originalballs = [];
	for (var i = 0; i < balls.length; i++){
		originalballs[i] = {};
		originalballs[i].x = balls[i].x;
		originalballs[i].y = balls[i].y;
	}
	console.log(originalballs);
	board = json.board;
	goal = json.goal;
	obstacles = json.obstacles;
	drawing = false;
	score = 0;
	//
	//console.log(json);


$(document).ready(function(){

	var animation;

	var stage = new Kinetic.Stage({
		container: 'container',
		width: 600,
		height: 450
	});

	var layer = new Kinetic.Layer({
		width: stage.width(),
		height: stage.height()
	});
	var balllayer = new Kinetic.Layer({
		width: stage.width(),
		height: stage.height()
	});

	drawBackground(layer, board);
	var circs = drawBalls(balllayer, balls, board, "#FF0000");
	//console.log(circs);
	drawRect(layer, goal, board, "#00FF00");
	drawObstacles(layer,obstacles,board,"#882200");
	
	$("div.score").replaceWith("<div align = 'center' class = 'score'>SCORE: "+score+"</div>"
);

	$('#reset').click(function(e){
  		e.preventDefault();
  		animation.stop();
  		reset(balllayer, balls, originalballs);
  	});

	//alert(JSON.stringify(json, null, 4));
  	$('#draw').click(function(e){
  		e.preventDefault();
  		var anim;
	    	var dx = new Function('x','y', 'return '+document.getElementById("dx").value+';');
	      	var dy = new Function('x','y', 'return '+document.getElementById("dy").value+';');
	      	var equation = {'dx': dx, 'dy': dy};

	    	animation = new Kinetic.Animation(
	    		function(frame) {
	    			var bz = balllayer.getChildren();
	    			var done = bz.length;
	    			balllayer.draw();
					for (var i = 0; i < balls.length; i++)
					{
						balls[i].valid = true;
						balls[i].points = 0;
						var newball = getEulerApprox(balls[i],dx,dy,0.05);
						for (var o = 0; o < obstacles.length; o++){
							if (inRect(newball,obstacles[o])){
								//console.log("hit obstacle");
								balls[i].points = -1;
								balls[i].valid = false;
							}
						}
							if (inRect(newball,goal)){
								//console.log("goal!");
								balls[i].valid = false;
								balls[i].points = 1;
							}

						if (inRect(newball,board) && balls[i].valid){
							balls[i] = newball;
							bz[i].x((balls[i].x-board.x)/board.width*balllayer.width());
							bz[i].y(balllayer.height()*(1-((balls[i].y-board.y)/board.height)));
							balls[i].points = 0;
						}else{
							done--;
							//score-=1;				
						}

		    		}
		    		if (done==0) {
		    			drawing = false;
		    			this.stop();
		    		}

		    		score = 0;
		    		for (var i = 0; i < balls.length; i++){
		    			console.log("balls["+i+"].points = "+balls[i].points);
		    			score += balls[i].points;
		    			}
		    		console.log("score = "+score);
		    		$("div.score").replaceWith("<div align = 'center' class = 'score'>SCORE: "+score+"</div>");

		  		}
		  	, balllayer);

  		if (!drawing){
  			console.log("drawing");
  			drawing = true;
	        animation.start();
	    }else{
	    	console.log("stopping");
	    	drawing = false;
	    	animation.stop();
	    }

	});
	// add the layers to the stage
	stage.add(layer);
	stage.add(balllayer);

  });


	

</script>
</body>

</html>
